<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Master - Professional Edition</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #4ade80; --text: #f1f5f9; --note: #94a3b8; --daily: #38bdf8; --hazama: #fbbf24; --full: #f43f5e; --long: #a855f7; --none: #64748b; --danger: #ef4444; --gold: #ffd700; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; }
        .container { max-width: 600px; margin: auto; padding: 0 10px; }
 
        /* å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ */
        .fixed-header { position: sticky; top: 0; z-index: 1100; background: var(--bg); padding-top: 5px; border-bottom: 2px solid #334155; }
        .top-status-bar { background: #1e293b; display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; border-radius: 8px; margin-bottom: 8px; }
        .header-left { display: flex; flex-direction: column; }
        .info-date { font-weight: bold; color: var(--accent); font-size: 0.95rem; }
        .info-reset { font-size: 0.7rem; color: var(--hazama); }
        .pts-badge { background: #0f172a; border: 1px solid var(--accent); padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 1.1rem; }
        .pts-badge.reached { background: var(--success); color: #000; border-color: #fff; }
 
        /* è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ãƒ»æ“ä½œãƒ‘ãƒãƒ« */
        .add-form { background: #334155; padding: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
        .input-row { display: flex; gap: 5px; align-items: center; }
        select, input { padding: 8px; border-radius: 4px; border: none; font-size: 12px; background: white; color: #000; }
        .add-btn { background: var(--success); color: #000; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; flex: 1; }
       
        /* CSVæ“ä½œãƒœã‚¿ãƒ³ */
        .csv-actions { display: flex; gap: 5px; margin-top: 2px; }
        .csv-btn { background: #475569; color: white; border: none; padding: 5px; border-radius: 4px; font-size: 10px; flex: 1; cursor: pointer; }
        .csv-btn:hover { background: #64748b; }
 
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        #mainContent { position: relative; padding-top: 10px; }
        .locked { opacity: 0.1; pointer-events: none; filter: blur(4px); }
        .reward-alert-section { background: var(--gold); color: #000; padding: 8px; border-radius: 8px; margin-bottom: 10px; text-align: center; font-weight: bold; font-size: 0.85rem; }
 
        .cat-section { margin-top: 10px; }
        .cat-header { font-size: 0.85rem; font-weight: bold; padding: 10px; border-radius: 6px; margin-bottom: 4px; cursor: pointer; display: flex; justify-content: space-between; }
        .cat-section.closed .task-list { display: none; }
       
        .cat-daily { background: var(--daily); color: #000; }
        .cat-reward { background: var(--gold); color: #000; }
        .cat-hazama { background: var(--hazama); color: #000; }
        .cat-full { background: var(--full); color: #fff; }
        .cat-long { background: var(--long); color: #fff; }
        .cat-none { background: var(--none); color: #fff; }
 
        .task-item { display: flex; align-items: center; background: var(--card); padding: 8px; margin-bottom: 6px; border-radius: 8px; }
        .task-item.checked { opacity: 0.3; filter: grayscale(1); }
        input[type="checkbox"] { width: 24px; height: 24px; margin-right: 10px; }
        .task-info { flex: 1; }
        .task-name { font-weight: bold; font-size: 0.85rem; }
        .task-note { font-size: 0.75rem; color: var(--note); border-bottom: 1px dashed #666; cursor: pointer; }
        .today-alert { background: var(--danger); color: white; padding: 1px 3px; border-radius: 3px; }
 
        .tool-box { display: flex; flex-direction: column; gap: 2px; }
        .tool-btn { background: #475569; color: white; border: none; border-radius: 3px; padding: 2px 5px; font-size: 9px; cursor: pointer; }
        .del-btn { background: var(--danger); }
        .btn-reset { width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; margin: 20px 0; font-weight: bold; cursor: pointer; }
       
        #csvFile { display: none; }
    </style>
</head>
<body>
 
<div class="container">
    <div class="fixed-header">
        <div class="top-status-bar">
            <div class="header-left">
                <span class="info-date" id="dateDisplay">---</span>
                <span class="info-reset" id="resetDisplay">---</span>
            </div>
            <div class="header-right"><div id="ptsBadge" class="pts-badge">0</div></div>
        </div>
 
        <div class="add-form">
            <div class="input-row">
                <select id="daySelector" onchange="checkLock()" style="flex:2; background: #0f172a; color: white; border: 1px solid var(--accent);">
                    <option value="">-- æ›œæ—¥ã‚’é¸æŠã—ã¦ãƒ­ãƒƒã‚¯è§£é™¤ --</option>
                    <option value="mon">æœˆæ›œæ—¥ï¼ˆæ³¡æ›´æ–°ï¼‰</option><option value="wed">æ°´æ›œæ—¥ï¼ˆæ³¡æ›´æ–°ï¼‰</option><option value="fri">é‡‘æ›œæ—¥ï¼ˆæ³¡æ›´æ–°ï¼‰</option><option value="other">ç«æœ¨åœŸæ—¥ã¯æ›´æ–°ãªã—</option>
                </select>
            </div>
            <div class="input-row">
                <input type="text" id="newName" style="flex:2" placeholder="æ–°è¦é …ç›®å">
                <input type="number" id="newPts" style="flex:0.5" placeholder="pt">
                <button class="add-btn" onclick="addNewTask()">è¿½åŠ </button>
            </div>
            <div class="input-row">
                <select id="newCat" style="flex:1">
                    <option value="hazama">ç‹­é–“</option><option value="full">ãƒ•ãƒ«</option><option value="long">é•·æœŸ</option><option value="daily" selected>ãƒ‡ã‚¤ãƒªãƒ¼</option><option value="none">å¾…æ©Ÿ</option>
                </select>
                <div class="csv-actions" style="flex:1">
                    <button class="csv-btn" onclick="exportCSV()">ğŸ“¤ CSVå‡ºåŠ›</button>
                    <button class="csv-btn" onclick="document.getElementById('csvFile').click()">ğŸ“¥ CSVèª­è¾¼</button>
                    <input type="file" id="csvFile" accept=".csv" onchange="importCSV(this)">
                </div>
            </div>
        </div>
    </div>
 
    <div id="mainContent" class="locked">
        <div id="rewardAlert" class="reward-alert-section" style="display: none;">ğŸ å—å–å¯èƒ½ãªãƒªãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ï¼</div>
        <div id="categoryContainers"></div>
        <button class="btn-reset" onclick="resetAll()">å…¨ãƒªã‚»ãƒƒãƒˆï¼ˆç¿Œæœç”¨ï¼‰</button>
    </div>
</div>
 
<script>
    const catNames = { reward: "ğŸ ã€å³å›åã€‘å—å–å¯èƒ½ãƒªãƒ¯ãƒ¼ãƒ‰", daily: "ãƒ‡ã‚¤ãƒªãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£", hazama: "ç‹­é–“ã‚¤ãƒ™ãƒ³ãƒˆ", full: "ãƒ•ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ", long: "é•·æœŸã‚¤ãƒ™ãƒ³ãƒˆ", none: "ä»Šã¯ãªã—ï¼ˆå¾…æ©Ÿä¸­ï¼‰" };
    let catStatus = JSON.parse(localStorage.getItem('catStatus')) || { reward: true, daily: true, hazama: false, full: false, long: false, none: false };
 
    // åˆæœŸãƒ‡ãƒ¼ã‚¿
    const defaultActivities = [
        { name: "è³‡æºã®æ¡å–", pts: 5, note: "ãƒªã‚»ãƒƒãƒˆå‰ã‹ã‚‰", cat: "daily", checked: false },
        { name: "ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼é¨å£«å›£", pts: 3, note: "ç›—ã¾ã‚Œãªã„ã‚ˆã†ã«", cat: "daily", checked: false },
        { name: "ç¾äººã«æŒ¨æ‹¶", pts: 10, note: "5å›ä»¥ä¸Šï¼", cat: "daily", checked: false },
        { name: "ç¾äººã¨äº¤æµ", pts: 0, note: "å¿˜ã‚Œãšã«ï¼", cat: "daily", checked: false },
        { name: "éºè·¡ã®æ¢æ¤œï¼’å›", pts: 10, note: "æœªå é ˜ã‚’ç¢ºèª", cat: "daily", checked: false },
        { name: "ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«", pts: 3, note: "1æšç›®å…¨éƒ¨", cat: "daily", checked: false },
        { name: "åŒç›Ÿã‚·ãƒ§ãƒƒãƒ—", pts: 0, note: "å¿˜ã‚Œãšã«", cat: "daily", checked: false },
        { name: "ã‚´ãƒ¼ãƒ«ãƒ‰ã®å¾´ç¨", pts: 5, note: "ç‹åŸ", cat: "daily", checked: false },
        { name: "ãƒ‰ãƒ©ã‚´ãƒ³ã«é¤Œ", pts: 3, note: "ç´ æåˆæˆ", cat: "daily", checked: false },
        { name: "è³‡æºã®åç©«", pts: 3, note: "å—å–ã‚Œã°åˆ°é”", cat: "daily", checked: false },
        { name: "è³‡æºã®å¾´å", pts: 5, note: "35å›", cat: "daily", checked: false },
        { name: "ç¥­ç¥€", pts: 9, note: "20å›", cat: "daily", checked: false },
        { name: "å…µå£«ã®è¨“ç·´", pts: 15, note: "500å", cat: "daily", checked: false },
        { name: "å…µå£«ã®å›å¾©", pts: 6, note: "150å", cat: "daily", checked: false },
        { name: "ç½ ã®ä½œæˆ", pts: 6, note: "500å€‹", cat: "daily", checked: false },
        { name: "ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®è¨ä¼", pts: 15, note: "5å›", cat: "daily", checked: false },
        { name: "ãŠãŸã™ã‘", pts: 5, note: "5å›", cat: "daily", checked: false },
        { name: "åŒç›Ÿã®å¯„ä»˜", pts: 10, note: "10å›", cat: "daily", checked: false },
        { name: "ã‚¹ã‚¿ãƒŸãƒŠ", pts: 9, note: "180æ¶ˆè²»", cat: "daily", checked: false },
        { name: "é—‡å¸‚", pts: 12, note: "3å›", cat: "daily", checked: false },
        { name: "ãƒ©ãƒƒã‚­ãƒ¼ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ", pts: 3, note: "1å›", cat: "daily", checked: false },
        { name: "è£…å‚™ã®å¼·åŒ–", pts: 0, note: "150å›", cat: "daily", checked: false },
        { name: "å°†è»ã®å¼·åŒ–", pts: 15, note: "5å›å¼·åŒ–", cat: "daily", checked: false },
        { name: "æ•µå…µã®æ’ƒé€€", pts: 15, note: "", cat: "daily", checked: false },
        { name: "PvPãƒãƒˆãƒ«", pts: 9, note: "", cat: "daily", checked: false },
        { name: "ç ”ç©¶", pts: 8, note: "1å›ã§ã‚ˆã„", cat: "daily", checked: false },
        { name: "å¼·åˆ¶åŠ´åƒ", pts: 3, note: "1å›ã§ã‚ˆã„", cat: "daily", checked: false },
        { name: "ãƒªãƒ¯ãƒ¼ãƒ‰120", pts: 0, note: "120ptæº€é¡", cat: "daily", checked: false },
        { name: "ãƒªãƒ¯ãƒ¼ãƒ‰145", pts: 0, note: "145ptæº€é¡", cat: "daily", checked: false }
    ];
 
    let activities = JSON.parse(localStorage.getItem('activities')) || defaultActivities;
 
    function saveData() {
        localStorage.setItem('activities', JSON.stringify(activities));
        localStorage.setItem('catStatus', JSON.stringify(catStatus));
    }
 
    function updateHeader() {
        const now = new Date();
        const year = now.getFullYear();
        const dateStr = now.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric', weekday: 'short' });
        document.getElementById('dateDisplay').innerText = dateStr;
        const dstStart = getNthSunday(year, 2, 2); dstStart.setDate(dstStart.getDate() + 1);
        const dstEnd = getNthSunday(year, 10, 1); dstEnd.setDate(dstEnd.getDate() + 1);
        const isSummer = now >= dstStart && now < dstEnd;
        document.getElementById('resetDisplay').innerText = `ãƒªã‚»ãƒƒãƒˆ: ${isSummer ? '16:00' : '17:00'}`;
        return `${now.getMonth() + 1}/${now.getDate()}`;
    }
    function getNthSunday(y, m, n) { let d = new Date(y, m, 1); let c = 0; while (c < n) { if (d.getDay() === 0) c++; if (c < n) d.setDate(d.getDate() + 1); } return d; }
    const todayMD = updateHeader();
 
    function renderList() {
        const container = document.getElementById('categoryContainers');
        container.innerHTML = "";
        let currentTotal = calculateTotal();
        let rewardPending = false;
 
        Object.keys(catNames).forEach(catKey => {
            const catTasks = activities.filter(t => {
                const match = t.note ? t.note.match(/(\d+)ptæº€é¡/) : null;
                const isReady = match && currentTotal >= parseInt(match[1]);
                if (catKey === 'reward') return isReady && !t.checked;
                if (t.cat === catKey) return !(isReady && !t.checked);
                return false;
            });
            if (catTasks.length === 0 && (catKey !== 'daily' && catKey !== 'reward' && catKey !== 'none')) return;
            if (catKey === 'reward' && catTasks.length === 0) return;
            if (catKey === 'reward') rewardPending = true;
 
            const section = document.createElement('div');
            section.className = `cat-section ${catStatus[catKey] ? '' : 'closed'}`;
            section.innerHTML = `<div class="cat-header cat-${catKey}" onclick="toggleCategory('${catKey}')"><span>${catNames[catKey]}</span><span>${catTasks.filter(t=>t.checked).length}/${catTasks.length}</span></div><div class="task-list"></div>`;
            const listDiv = section.querySelector('.task-list');
            catTasks.forEach(task => {
                const idx = activities.indexOf(task);
                const div = document.createElement('div');
                div.className = `task-item ${task.checked ? 'checked' : ''}`;
                div.innerHTML = `<input type="checkbox" onchange="toggleTask(${idx})" ${task.checked ? 'checked' : ''}><div class="task-info"><span class="task-name">${task.name} (${task.pts}pt)</span><div class="task-note ${task.note && task.note.includes(todayMD) ? 'today-alert' : ''}" onclick="editNote(${idx})">${task.note || '(å‚™è€ƒç·¨é›†)'}</div></div><div class="tool-box"><button class="tool-btn" onclick="moveTask(${idx},-1)">â–²</button><button class="tool-btn" onclick="moveTask(${idx},1)">â–¼</button><button class="tool-btn" onclick="changeCategory(${idx})">ğŸ”„</button>${task.cat==='none'?'<button class="tool-btn del-btn" onclick="deleteTask('+idx+')">ğŸ—‘ï¸</button>':''}</div>`;
                listDiv.appendChild(div);
            });
            container.appendChild(section);
        });
        document.getElementById('rewardAlert').style.display = rewardPending ? 'block' : 'none';
        updateScore(currentTotal);
        saveData();
    }
 
    function calculateTotal() { let t = 0; activities.forEach(a => { if (a.checked && a.cat === 'daily') t += a.pts; }); return t; }
    function updateScore(t) { const b = document.getElementById('ptsBadge'); b.innerText = t; if (t >= 145) b.classList.add('reached'); else b.classList.remove('reached'); }
    function toggleTask(i) { activities[i].checked = !activities[i].checked; renderList(); }
    function toggleCategory(k) { catStatus[k] = !catStatus[k]; renderList(); }
    function checkLock() { document.getElementById('mainContent').className = document.getElementById('daySelector').value !== "" ? "" : "locked"; }
    function editNote(i) { const n = prompt("å‚™è€ƒ:", activities[i].note); if (n !== null) { activities[i].note = n; renderList(); } }
    function changeCategory(i) { const k = Object.keys(catNames); activities[i].cat = k[(k.indexOf(activities[i].cat) + 1) % k.length]; if(activities[i].cat==='reward') activities[i].cat='daily'; renderList(); }
    function moveTask(idx, dir) { const target = idx + dir; if (target >= 0 && target < activities.length && activities[idx].cat === activities[target].cat) { [activities[idx], activities[target]] = [activities[target], activities[idx]]; renderList(); } }
    function addNewTask() { const n = document.getElementById('newName').value; const p = parseInt(document.getElementById('newPts').value) || 0; const c = document.getElementById('newCat').value; if(n){ activities.unshift({name:n,pts:p,cat:c,checked:false,note:""}); catStatus[c]=true; document.getElementById('newName').value=""; document.getElementById('newPts').value=""; renderList(); } }
    function deleteTask(idx) { if(confirm("æ¶ˆå»ï¼Ÿ")) { activities.splice(idx,1); renderList(); } }
    function resetAll() { if(confirm("å…¨ãƒªã‚»ãƒƒãƒˆï¼Ÿ")) { activities.forEach(a => a.checked = false); document.getElementById('daySelector').value = ""; checkLock(); renderList(); } }
 
    // --- CSVæ©Ÿèƒ½ ---
    function exportCSV() {
        let csv = "\uFEFFã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚­ãƒ¼,é …ç›®å,ãƒã‚¤ãƒ³ãƒˆ,å‚™è€ƒ\n"; // BOMä»˜ãã§Excelæ–‡å­—åŒ–ã‘é˜²æ­¢
        activities.forEach(a => {
            csv += `${a.cat},${a.name},${a.pts},${a.note}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "game_tasks.csv";
        link.click();
    }
 
    function importCSV(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split("\n");
            const newActivities = [];
            for(let i=1; i<lines.length; i++) {
                const cols = lines[i].split(",");
                if(cols.length >= 3) {
                    newActivities.push({
                        cat: cols[0].trim(),
                        name: cols[1].trim(),
                        pts: parseInt(cols[2]) || 0,
                        note: cols[3] ? cols[3].trim() : "",
                        checked: false
                    });
                }
            }
            if(newActivities.length > 0) {
                if(confirm(newActivities.length + "ä»¶ã®é …ç›®ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ç¾åœ¨ã®ãƒªã‚¹ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                    activities = newActivities;
                    renderList();
                }
            }
        };
        reader.readAsText(file);
    }
 
    renderList();
</script>
</body>
</html>
